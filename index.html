<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.2/howler.core.min.js"></script>
<style>
<style>
* {
    margin: 0;
    padding: 0;
}
html, body {
    margin: 0;
    width: 100%;
    height: 100%;
    border: 0;
    overflow: hidden;
    display: block;
}
#canvas {
    position:absolute;
    left:0px;
    top:0px;
}
</style>
</head>
<body>
<script>

class Dot {
    constructor(pulse, symbol) {
        this.pulse = pulse
        this.symbol = symbol
        this.played_pulse = null
    }
    get active() {
        return this.symbol != '.'
    }
}

class Ring {
    constructor(name, sound, pattern) {
        this.name = name
        this.sound = sound
        this.dots = []
        let pulse = 0
        for (const symbol of pattern) {
            if (symbol == ' ') continue
            
            this.dots.push(new Dot(pulse, symbol))
            pulse++
        }
        this.period = this.dots.length
    }
}

var pulse_width = 150

var sounds = {
    'beat':      new Howl({ src: 'beat-wood.mp3' }),
    'beat_high': new Howl({ src: 'beat-wood-high.mp3' }),
    'clap':      new Howl({ src: 'clap.mp3' }),
    'shake':     new Howl({ src: 'shake.mp3' }),
}

var rings = [
    new Ring("pri-beats", sounds.shake,     "x... x... x... x... x... x... x... x..."),
    new Ring("main",      sounds.beat,      "..x. .x.. x..x ..x. .x.. x.xx ..x. ...."),
]

function in_limits(x, l1, l2) {
    return x >= l1 && x < l2
}

function update(elapsed) {
    for (let ring of rings) {
        const pulse = elapsed / pulse_width
        
        //console.log(`process elapsed=${elapsed} ring_name=${ring.name} pulse=${pulse}`)
        
        for (let dot of ring.dots) {
            if (dot.active
                && in_limits((pulse - dot.pulse) % ring.period, -0.1, 1.0)
                && (dot.played_pulse ==  null || pulse - dot.played_pulse > ring.period - 0.1)) {
                
                ring.sound.play()
                dot.played_pulse = pulse
                
                console.log(`playing pulse=${pulse} ring_name=${ring.name} dot=${dot.pulse}`)
            }
        }
    }
}

function process(ts) {
    if (start_ts) {
        update(ts - start_ts)
    }
    draw(ts - start_ts)
    window.requestAnimationFrame(process)
}

function on_click() {
    if (start_ts) {
        console.log(`stopping ts=${start_ts}`)
        start_ts = 0;
        for (let ring of rings) {         
            for (let dot of ring.dots) {
                dot.played_pulse = null
            }
        }
    } else {
        start_ts = performance.now()
        console.log(`starting ts=${start_ts}`)
    }
}

function draw(elapsed) {
    const pulse = elapsed / pulse_width
    
    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    ctx.strokeStyle = 'blue'
    ctx.lineWidth = '5'
    ctx.strokeRect(0, 0, window.innerWidth, window.innerHeight)
    
    let width = Math.min(canvas.width, canvas.height)
    let radius = width * 0.45
    for (let ring of rings) {
        ctx.beginPath()
        ctx.arc(canvas.width / 2, canvas.height / 2, radius, 0, 2 * Math.PI)
        ctx.strokeStyle = 'black'
        ctx.lineWidth = '2'
        ctx.stroke()
        for (let dot of ring.dots) {
            let angle = 2 * Math.PI * dot.pulse / ring.period
            let dot_x = canvas.width / 2 + Math.sin(angle) * radius
            let dot_y = canvas.height / 2 - Math.cos(angle) * radius
            let dot_size = width * 0.010

            ctx.beginPath()
            ctx.arc(dot_x, dot_y, dot_size, 0, 2 * Math.PI)

            ctx.strokeStyle = 'black'
            ctx.lineWidth = '5'

            if (dot.active) {
                ctx.fillStyle = 'black'
                if (start_ts && in_limits((pulse - dot.pulse) % ring.period, -0.1, 0.9)) {
                    ctx.fillStyle = 'blue'
                    ctx.strokeStyle = 'blue'
                }
            } else {
                ctx.fillStyle = 'white'
            }
            
            ctx.fill()
            ctx.stroke()
        }
        if (rings.length > 1) {
            radius -= width * 0.2 / (rings.length - 1)
        }
    }
}

function resize() {
    const canvas = document.getElementById('canvas')
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
}

window.requestAnimationFrame(process)
window.addEventListener("click", on_click)
window.addEventListener('resize', resize, false)
document.addEventListener('DOMContentLoaded', resize)
var start_ts = 0

   
</script>
<canvas id=canvas>
</canvas>
</body>
</html>